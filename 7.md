# Aggregate functions

721 2.05
![](pics/29.png)


* работать не будет

722 1.05 
![](pics/30.png)


* вот такой будет

722 1.25
![](pics/31.png)

* или

722 2.14
![](pics/32.png)

* Порядок вычисления
  * from where
  * group by
  * having
  * select

* выглядит сложно, но всего лишь находит те статьи в которых 2 ключевых слова, поданные на конференции на которые всего подано больше чем 100 статей
 
731 0.12
![](pics/33.png)

* упрощения запроса через представления

732 0.39
![](pics/38.png)


* представления - часть схемы БД. Может не быть прав на изменение схемы
* представление должно иметь смысл и быть полезным в рамках всей БД, а не только одного запроса
* лучше использовать обобщенные табличные выражения.
  * WITH и затем идет локальное представление
  * MySql их не поддерживает

732 1.55
![](pics/35.png)

* часто нужно знать, что внутри группы - например для каждой конференции каждого года узнать отношение кол-ва статей поданных в этом году на конференцию к среднему значению статей, поданных на конференцию за все время ее проведения
* решить можно так

741 1.06
![](pics/36.png)


## Оконная функция

* относительно новая фича
* разбивает выборку на партиции (аналогично группировке строк)
* каждая партиция сортируется по указанному в запросе признаку
* select кроме текущей строки может оперировать с окном, состоящим из строк из той же партиции
* MySql и Sqlite не поддерживают

741 3.13
![](pics/37.png)

741 4.13
![](pics/39.png)

741 4.59

742 0.10
![](pics/40.png)
* если партиция неупорядоченна, значения аггрегатной функции вычисляется по всем строкам попавшим в одну партицию 
* если партиция упорядоченна при помощи order by в дело вступает окно и аггрегатная функция вычисляется для строк которые в настоящий момент составляют содержимое окна 
* по умолчанию окно начинается с первой строки партиции и заканчивается на той строке, которая в настоящий момент обрабатывается
* если бы была еще одна конференция с 2015 годом, она бы тоже попала в обработку
742 1.10

* FIRST_VALUE - аггрегатная функция, возвращающая первое значение из данного ей окна
* between 1 preceding and current row - в окно входят строкии из диапазона: одна предыдущая строка относительно текущей строки и текущая строка
* FIRST_VALUE в данном случае вернет значение предыдущей строки

742 1.30
![](pics/41.png)

2.04
![](pics/42.png)

2.23
![](pics/43.png)

3.12
![](pics/44.png)




